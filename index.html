<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Face Recognition Cleaner</title>
    
    <!-- Face API JS -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }

        body { background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        /* Header */
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .badge { background: #e0e7ff; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.05em; }

        /* Main Layout */
        main { flex: 1; display: grid; grid-template-columns: 320px 1fr; height: calc(100vh - 65px); }

        /* Sidebar */
        aside { background: var(--surface); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; overflow-y: auto; }
        
        h3 { font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin-bottom: 0.75rem; font-weight: 700; letter-spacing: 0.05em; }
        
        .upload-box {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
        }
        .upload-box:hover { border-color: var(--primary); background: #eff6ff; }
        .upload-box i { font-size: 1.5rem; color: #94a3b8; margin-bottom: 0.5rem; }
        
        /* Reference Image Preview */
        .ref-preview-container {
            width: 100%;
            height: 150px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: none;
        }
        .ref-preview-container img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .ref-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 0.75rem; text-align: center; }

        input[type="file"] { display: none; }

        .btn {
            width: 100%; padding: 0.875rem; border: none; border-radius: 8px;
            background: var(--primary); color: white; font-weight: 600;
            cursor: pointer; transition: 0.2s; opacity: 0.5; pointer-events: none;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn.active { opacity: 1; pointer-events: all; }
        .btn:hover { background: var(--primary-hover); }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: var(--bg); padding: 10px; border-radius: 6px; text-align: center; }
        .stat-val { font-size: 1.25rem; font-weight: 700; }
        .stat-lbl { font-size: 0.7rem; color: #64748b; }

        /* Content / Gallery */
        .content { padding: 2rem; overflow-y: auto; background: #f1f5f9; }

        .progress-area { margin-bottom: 2rem; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: none; }
        .bar-bg { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-bottom: 0.5rem; }
        .bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        
        .card {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative;
            transition: transform 0.2s;
        }
        .card img { width: 100%; height: 160px; object-fit: cover; }
        .card-meta { padding: 0.75rem; }
        .filename { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .distance-score { font-size: 0.7rem; color: #64748b; margin-top: 2px; }

        .status-flag { position: absolute; top: 8px; right: 8px; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; color: white; }
        .match { background: var(--success); }
        .nomatch { background: var(--danger); }

        /* Loader */
        #sys-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="sys-loader">
        <div class="spinner"></div>
        <h3 style="margin-top: 1rem; color: var(--text);">Loading Biometric Models...</h3>
        <p style="font-size: 0.8rem; color: #64748b;">Fetching Neural Networks (SSD MobileNet & FaceLandmark68)</p>
    </div>

    <header>
        <div class="logo">
            <i class="fa-solid fa-fingerprint"></i>
            BioSort AI
            <span class="badge">PRO</span>
        </div>
        <div style="font-size: 0.85rem; color: #64748b;">
            <i class="fa-solid fa-lock"></i> Privacy Mode: On-Device Processing
        </div>
    </header>

    <main>
        <aside>
            <!-- Step 1: Reference Face -->
            <div>
                <h3>1. Target Person (Reference)</h3>
                <div class="upload-box" id="refBox" onclick="document.getElementById('refInput').click()">
                    <i class="fa-solid fa-user-tag"></i>
                    <p>Upload Face to Keep</p>
                    <input type="file" id="refInput" accept="image/*">
                </div>
                <div class="ref-preview-container" id="refPreview">
                    <img id="refImgElement" src="">
                    <div class="ref-overlay"><i class="fa-solid fa-check-circle"></i> Target Lock</div>
                </div>
                <p id="ref-status" style="font-size:0.75rem; color:var(--danger); margin-top:5px; display:none;"></p>
            </div>

            <!-- Step 2: Batch -->
            <div>
                <h3>2. Batch Images</h3>
                <div class="upload-box" onclick="document.getElementById('batchInput').click()">
                    <i class="fa-solid fa-images"></i>
                    <p>Select Folder/Files</p>
                    <input type="file" id="batchInput" multiple accept="image/*">
                </div>
                <div id="batch-count" style="text-align:center; font-size:0.8rem; margin-top:5px; color:var(--primary);"></div>
            </div>

            <!-- Step 3: Controls -->
            <div style="margin-top: auto;">
                <div class="stats-grid" style="margin-bottom: 1rem;">
                    <div class="stat-box">
                        <div class="stat-val" style="color: var(--success);" id="count-kept">0</div>
                        <div class="stat-lbl">Matched</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" style="color: var(--danger);" id="count-removed">0</div>
                        <div class="stat-lbl">No Match</div>
                    </div>
                </div>
                <button id="runBtn" class="btn">
                    <i class="fa-solid fa-bolt"></i> Start Scanning
                </button>
            </div>
        </aside>

        <div class="content">
            <div class="progress-area" id="progress-area">
                <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                    <strong style="font-size:0.9rem;">Analyzing Biometrics...</strong>
                    <span id="prog-text" style="font-size:0.8rem; color:#64748b;">0%</span>
                </div>
                <div class="bar-bg"><div class="bar-fill" id="bar-fill"></div></div>
            </div>

            <div class="gallery" id="gallery"></div>
        </div>
    </main>

    <script>
        // --- Configuration ---
        // Using the public model weights hosted by the face-api.js author for demo purposes
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        
        // Threshold: Lower = stricter match, Higher = looser match. 0.6 is standard.
        const MATCH_THRESHOLD = 0.6; 

        // --- State ---
        let referenceDescriptor = null;
        let batchFiles = [];

        // --- Elements ---
        const loader = document.getElementById('sys-loader');
        const refInput = document.getElementById('refInput');
        const batchInput = document.getElementById('batchInput');
        const runBtn = document.getElementById('runBtn');
        const gallery = document.getElementById('gallery');
        const refPreview = document.getElementById('refPreview');
        const refBox = document.getElementById('refBox');
        
        // --- Initialization ---
        async function loadModels() {
            try {
                // Load detection, landmark (alignment), and recognition (embedding) models
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                loader.style.display = 'none';
                console.log("AI Models Loaded");
            } catch (e) {
                alert("Error loading models. Check internet connection.");
                console.error(e);
            }
        }
        loadModels();

        // --- Reference Image Handling ---
        refInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            // UI Updates
            const imgUrl = URL.createObjectURL(file);
            document.getElementById('refImgElement').src = imgUrl;
            refBox.style.display = 'none';
            refPreview.style.display = 'block';
            
            // Compute Descriptor
            const statusMsg = document.getElementById('ref-status');
            statusMsg.style.display = 'block';
            statusMsg.style.color = '#64748b';
            statusMsg.textContent = "Computing face biometrics...";

            try {
                // Convert file to HTMLImageElement for FaceAPI
                const img = await faceapi.bufferToImage(file);
                
                // Detect single face
                const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                
                if (!detection) {
                    statusMsg.style.color = 'var(--danger)';
                    statusMsg.textContent = "No face detected in reference photo!";
                    referenceDescriptor = null;
                    checkReady();
                    return;
                }

                referenceDescriptor = detection.descriptor;
                statusMsg.style.color = 'var(--success)';
                statusMsg.textContent = "Face biometric signature locked.";
                checkReady();

            } catch (err) {
                console.error(err);
                statusMsg.textContent = "Error processing image.";
            }
        });

        // --- Batch Input Handling ---
        batchInput.addEventListener('change', (e) => {
            batchFiles = Array.from(e.target.files);
            document.getElementById('batch-count').textContent = `${batchFiles.length} images queued`;
            gallery.innerHTML = ''; // Clear previous
            checkReady();
        });

        function checkReady() {
            if (referenceDescriptor && batchFiles.length > 0) {
                runBtn.classList.add('active');
            } else {
                runBtn.classList.remove('active');
            }
        }

        // --- Core Processing ---
        runBtn.addEventListener('click', async () => {
            runBtn.classList.remove('active');
            const progressArea = document.getElementById('progress-area');
            const barFill = document.getElementById('bar-fill');
            const progText = document.getElementById('prog-text');
            
            progressArea.style.display = 'block';
            
            let kept = 0;
            let removed = 0;

            for (let i = 0; i < batchFiles.length; i++) {
                const file = batchFiles[i];
                
                // Update Progress
                const pct = Math.round(((i + 1) / batchFiles.length) * 100);
                barFill.style.width = `${pct}%`;
                progText.textContent = `${i+1}/${batchFiles.length}`;

                // Process
                const result = await processImage(file);
                
                if (result.match) kept++;
                else removed++;

                // Update Stats
                document.getElementById('count-kept').textContent = kept;
                document.getElementById('count-removed').textContent = removed;

                // Render
                addCardToGallery(result);
            }
            
            setTimeout(() => {
                progressArea.style.display = 'none';
                runBtn.classList.add('active');
                runBtn.innerHTML = `<i class="fa-solid fa-rotate-right"></i> Process New Batch`;
            }, 1500);
        });

        async function processImage(file) {
            const imgUrl = URL.createObjectURL(file);
            let isMatch = false;
            let distance = 1.0; // Default high distance (no match)

            try {
                const img = await faceapi.bufferToImage(file);
                
                // Detect ALL faces in the image
                const detections = await faceapi.detectAllFaces(img)
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                // Check every face found in the image against the reference
                for (const detection of detections) {
                    const dist = faceapi.euclideanDistance(referenceDescriptor, detection.descriptor);
                    
                    // If ANY face in the image matches the reference, keep the image
                    if (dist < MATCH_THRESHOLD) {
                        isMatch = true;
                        distance = dist;
                        break; // Found our person, no need to check other faces in this photo
                    }
                }
            } catch (e) {
                console.error("Error scanning file", file.name);
            }

            return {
                url: imgUrl,
                name: file.name,
                match: isMatch,
                score: distance
            };
        }

        function addCardToGallery(data) {
            const card = document.createElement('div');
            card.className = 'card';
            // Dim images that don't match
            card.style.opacity = data.match ? '1' : '0.5';

            const statusClass = data.match ? 'match' : 'nomatch';
            const statusText = data.match ? 'MATCH' : 'IGNORE';
            
            // Format score (lower is better match)
            const confidence = data.match 
                ? `<span style="color:var(--success)">Match Confidence: ${Math.round((1 - data.score) * 100)}%</span>` 
                : `Not detected`;

            card.innerHTML = `
                <div class="status-flag ${statusClass}">${statusText}</div>
                <img src="${data.url}" loading="lazy">
                <div class="card-meta">
                    <div class="filename" title="${data.name}">${data.name}</div>
                    <div class="distance-score">${confidence}</div>
                </div>
            `;
            gallery.prepend(card); // Add new images to top
        }

    </script>
</body>
</html>
